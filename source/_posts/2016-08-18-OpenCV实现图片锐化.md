---
title: OpenCV实现图片锐化
date: 2016-08-18 16:39:48
categories: OpenCV
tags: [OpenCV]
---

---
转载请说明出处！
作者：[kqw攻城狮](http://kongqw.github.io/about/index.html)
出处：[个人站](http://kongqw.github.io) | [CSDN](http://blog.csdn.net/q4878802/)

---

# 效果图

![效果图](http://img.blog.csdn.net/20160818170631519)

![效果图](http://img.blog.csdn.net/20160818170646648)

# 源码

[KqwOpenCVBlurDemo](https://github.com/kongqw/KqwOpenCVBlurDemo)

**锐化**也可以看作是一种线性滤波操作，并且锚点像素有较高的权重，而周围的像素权重较低。
因此，我们可以自定义一个这样的**核**。

![自定义核](http://img.blog.csdn.net/20160818170529752)

``` java
/*
    自定义核
     0	-1	 0
    -1   5	-1
     0	-1	 0
  */
Mat kernel = new Mat(3, 3, CvType.CV_16SC1);
kernel.put(0, 0, 0, -1, 0, -1, 5, -1, 0, -1, 0);
```

这里我们将图像的深度设为`16SC1`，表示包含一个通道（C1），图像中的每个像素包含一个16比特有符号整型数（16S）。


定义完**核**以后，我们对图像和**核**做卷积操作

``` java
// 对图像和自定义核做卷积
Imgproc.filter2D(src, src, src.depth(), kernel);
```

* 第一个参数表示输入的图像
* 第二个参数表示输出的图像
* 第三个参数表示图像的深度
* 第四个参数是我们自定义的核


# 封装

这里我用到了RxJava。主要是因为图片处理是耗时操作，会阻塞线程，为了防止界面卡顿，这里使用RxJava进行了线程切换。

``` java
/**
 * 锐化图片
 *
 * @param bitmap 要处理的图片
 */
public void filter2D(Bitmap bitmap) {
    // 使用RxJava处理图片
    if (null != mSubscriber)
        Observable
                .just(bitmap)
                .map(new Func1<Bitmap, Bitmap>() {

                    @Override
                    public Bitmap call(Bitmap bitmap) {
                        // Bitmap转为Mat
                        Mat src = new Mat(bitmap.getHeight(), bitmap.getWidth(), CvType.CV_8UC4);
                        Utils.bitmapToMat(bitmap, src);

                        /*
                            自定义核
                            0   -1  0
                            -1  5   -1
                            0   -1  0
                          */
                        Mat kernel = new Mat(3, 3, CvType.CV_16SC1);
                        kernel.put(0, 0, 0, -1, 0, -1, 5, -1, 0, -1, 0);
                        // 对图像和自定义核做卷积
                        Imgproc.filter2D(src, src, src.depth(), kernel);

                        // Mat转Bitmap
                        Bitmap processedImage = Bitmap.createBitmap(src.cols(), src.rows(), Bitmap.Config.ARGB_8888);
                        Utils.matToBitmap(src, processedImage);

                        return processedImage;
                    }
                })
                .subscribeOn(Schedulers.io())
                .observeOn(AndroidSchedulers.mainThread())
                .subscribe(mSubscriber);
}
```

# 调用

``` java
// 图片处理的工具类
mBlurUtil = new BlurUtil(new Subscriber<Bitmap>() {
    @Override
    public void onCompleted() {
        // 图片处理完成
        dismissProgressDialog();
    }

    @Override
    public void onError(Throwable e) {
        // 图片处理异常
        dismissProgressDialog();
    }

    @Override
    public void onNext(Bitmap bitmap) {
        // 获取到处理后的图片
        mIvImageProcessed.setImageBitmap(bitmap);
    }
});

// 锐化图片
mBlurUtil.filter2D(mSelectImage);
```