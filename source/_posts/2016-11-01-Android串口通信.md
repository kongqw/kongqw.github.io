---
title: Android串口通信
date: 2016-11-01 15:40:53
categories:
tags: [串口]
---

---
转载请说明出处！
作者：[kqw攻城狮](http://kongqw.github.io/about/index.html)
出处：[个人站](http://kongqw.com/2016/11/01/2016-11-01-Android%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1/) | [CSDN](http://blog.csdn.net/q4878802/article/details/52996548)

---


> 串口通信偏向嵌入式一点，是Android设备通过串口与其他设备进行通信的一种方式，本文介绍的Android纯串口的通信，并不是手机上的USB串口通信。

![P1](http://img.blog.csdn.net/20161101153352899)

> 手机上是没有这个串口的哦。

关于串口通信，Google已经给出了源码，地址在GitHub [android-serialport-api](https://github.com/cepr/android-serialport-api)

四年前的代码，还是Eclipse工程，本文主要介绍如何在Android Studio中使用。

源码地址在 [KqwSerialPortDemo](https://github.com/kongqw/KqwSerialPortDemo) 


# 集成

Java层的代码，Google已经给封装在 [SerialPort.java](https://github.com/kongqw/KqwSerialPortDemo/blob/master/SerialPortLibrary/src/main/java/qingwei/kong/serialportlibrary/SerialPort.java)


## 导入.so

没有什么难度了，将so导入到项目

![P1](http://img.blog.csdn.net/20161101153618510)

## 导入jni文件

在`main`目录下创建`cpp`文件夹，并将jni源文件和CMakeLists.txt导入

![P2](http://img.blog.csdn.net/20161101153635136)

在`build.gradle`配置`cmake`路径。

``` java
android {
    ……
    externalNativeBuild {
        cmake {
            path "src/main/cpp/CMakeLists.txt"
        }
    }
	……
｝
```

## 修改jni源文件

这里要注意jni文件函数名的写法：`Java_包名_类名_方法名`

![P3](http://img.blog.csdn.net/20161101153707996)

在将源码里的jni导入过来的时候，包名是源码Demo的包名，我们在自己的工程里要换成自己的包名、类名，源文件和头文件都要记得改。


## 修改CMakeLists.txt与SerialPort.java

CMakeLists.txt

``` java
cmake_minimum_required(VERSION 3.4.1)

add_library(SerialPort SHARED
            SerialPort.c)

# Include libraries needed for libserial_port lib
target_link_libraries(SerialPort
                      android
                      log)
```

SerialPort.java

``` java
static {
    System.loadLibrary("SerialPort");
    System.loadLibrary("serial_port");
}
```

# 使用

## 基类

需要使用串口通信的类继承 [SerialPortActivity.java](https://github.com/kongqw/KqwSerialPortDemo/blob/master/app/src/main/java/qingwei/kong/kqwserialportdemo/SerialPortActivity.java)

## 打开串口

* 端口号：/dev/ttyS2
* 比特率：115200

``` java
public SerialPort getSerialPort() throws SecurityException, IOException, InvalidParameterException {
    if (mSerialPort == null) {
        mSerialPort = new SerialPort(new File("/dev/ttyS2"), 115200, 0);
    }
    return mSerialPort;
}
```

## 关闭串口

``` java
public void closeSerialPort() {
    if (mSerialPort != null) {
        mSerialPort.close();
        mSerialPort = null;
    }
}
```

## 发送数据

``` java
Message message = Message.obtain();
message.obj = text.getBytes();
sendingHandler.sendMessage(message);
```

## 接收消息

``` java
@Override
protected void onDataReceived(final byte[] buffer, final int size) {
    runOnUiThread(new Runnable() {
        @Override
        public void run() {
            Toast.makeText(mApplication, "收到消息：" + new String(buffer) + "  size = " + size, Toast.LENGTH_SHORT).show();
        }
    });
}
```

# 下载并安装NDK与CMake

![下载并安装NDK与CMake](http://img.blog.csdn.net/20161104110635516)


